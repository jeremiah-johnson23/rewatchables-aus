name: Check for New Episodes

on:
  schedule:
    # Every Tuesday at 6:00 PM AEDT (07:00 UTC)
    - cron: '0 7 * * 2'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-and-add-episodes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check for new episodes
        id: check
        run: |
          output=$(python scripts/check_new_episodes.py --count 5)
          echo "$output"

          if echo "$output" | grep -q "Found.*new episode"; then
            echo "new_episodes=true" >> $GITHUB_OUTPUT
          else
            echo "new_episodes=false" >> $GITHUB_OUTPUT
          fi

      - name: Add new episodes to database
        if: steps.check.outputs.new_episodes == 'true'
        id: add
        run: |
          python scripts/add_new_episode.py --count 5

          # Capture what was added for commit message
          added=$(python scripts/check_new_episodes.py --latest | grep "Movie:" | cut -d: -f2 | xargs)
          echo "added_title=$added" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.check.outputs.new_episodes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add src/data/episodes.json
          git commit -m "Add new episode: ${{ steps.add.outputs.added_title }}

          Auto-added from podcast feed.

          ‚ö†Ô∏è Needs manual update: year, director, genres, streaming, studio

          ü§ñ Generated by GitHub Actions"
          git push

      - name: Create issue for manual data completion
        if: steps.check.outputs.new_episodes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const body = `## New Episode Auto-Added ‚úÖ

            A new Rewatchables episode was automatically added to the database.

            ### What was added
            - Episode entry with title, date, hosts from podcast feed
            - Basic structure with empty streaming data

            ### Manual updates needed
            The following fields need to be filled in:

            - [ ] **Year** - Movie release year
            - [ ] **Director** - Film director
            - [ ] **Genres** - e.g., Action, Drama, Comedy
            - [ ] **Streaming** - Check [JustWatch AU](https://www.justwatch.com/au)
            - [ ] **Studio** - See CLAUDE.md for studio keys
            - [ ] **Apple Podcasts URL** - Direct episode link

            ### How to complete
            1. Start a session with Claude Code
            2. Say "complete new episode data"
            3. Or manually edit \`src/data/episodes.json\`

            ---
            *Auto-added on ${today}*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[DATA NEEDED] Complete data for new episode - ${today}`,
              body: body,
              labels: ['new-episode', 'data-needed']
            });
